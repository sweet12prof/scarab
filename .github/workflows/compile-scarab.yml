# .github/workflows/compile-scarab.yml
name: Compile PR in Container

############################################################
# 1 â”€â”€â”€ Triggers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
############################################################
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

############################################################
# 2 â”€â”€â”€ Shared variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
############################################################
env:
  # SHA of the code being tested (PR head or merge commit)
  COMMIT_SHA: ${{ github.event.pull_request.head.sha || github.sha }}

############################################################
# 3 â”€â”€â”€ Job 0: look up infraâ€‘container tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
############################################################
jobs:

  get_tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.short }}
    steps:
      - id: tag
        name: Latest scarabâ€‘infra SHA
        run: |
          LATEST=$(curl -s https://api.github.com/repos/litz-lab/scarab-infra/commits/main | jq -r '.sha')
          echo "short=${LATEST:0:7}" >>"$GITHUB_OUTPUT"

############################################################
# 4 â”€â”€â”€ Job 1: build (opt) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
############################################################
 
  build-opt:
    runs-on: ubuntu-latest
    needs: get_tag
    if: github.event_name == 'pull_request'
    container:
      image: ghcr.io/litz-lab/scarab-infra/allbench_traces:${{ needs.get_tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Mark Git repo as safe
        run: git config --global --add safe.directory /__w/scarab_ll/scarab_ll

      - name: Build Scarab Dbg
        working-directory: src
        run: make opt -j

############################################################
# 5 â”€â”€â”€ Job 2: build (dbg) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
############################################################ 

  build-dbg:
    runs-on: ubuntu-latest
    needs: get_tag
    if: github.event_name == 'pull_request'
    container:
      image: ghcr.io/litz-lab/scarab-infra/allbench_traces:${{ needs.get_tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Mark Git repo as safe
        run: git config --global --add safe.directory /__w/scarab_ll/scarab_ll

      - name: Build Scarab Dbg
        working-directory: src
        run: make dbg -j

############################################################
# 6 â”€â”€â”€ Job 3: run simulation & extract metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
############################################################
  run-scarab:
    needs: [get_tag]
    runs-on: ubuntu-latest
    outputs:
      ipc:  ${{ steps.ipc.outputs.value }}
      kips: ${{ steps.kips.outputs.value }}
    env:
      TAG: ${{ needs.get_tag.outputs.tag }}
    steps:
      # Traces ------------------------------------------------
      - name: Fetch traces
        run: |
          curl -L -o traces.tar.gz \
            https://github.com/litz-lab/scarab-infra/releases/download/top_simpoint_perlbench/traces_top_simpoint.tar.gz
          tar -xzf traces.tar.gz

      # Code --------------------------------------------------
      - uses: actions/checkout@v4            # PR or main code
        with:
          path: scarab_ll
      - name: Clone scarabâ€‘infra
        run: git clone https://github.com/litz-lab/scarab-infra.git

      # Docker image -----------------------------------------
      - name: Pull sim container
        working-directory: scarab-infra
        run: |
          docker pull ghcr.io/litz-lab/scarab-infra/allbench_traces:${TAG}
          docker tag  ghcr.io/litz-lab/scarab-infra/allbench_traces:${TAG} allbench_traces:${TAG}

      # Simulation -------------------------------------------
      - name: Run simulation
        working-directory: scarab-infra
        run: |
          set -e
          chmod +x run.sh
          pip install -r requirements.txt
          ./run.sh --simulation top_simpoint

      # Extract KIPS -----------------------------------------
      - id: kips
        name: Grab KIPS
        working-directory: simulations
        run: |
          v=$(grep -oP '\(\K[0-9]+(?=\.[0-9]+\s*KIPS\))' \
              github_top_simpoint_workflow/this_pr/500.perlbench_r/29229/sim.log | head -n1)
          echo "value=$v" >>"$GITHUB_OUTPUT"

      # Extract IPC ------------------------------------------
      - id: ipc
        name: Grab IPC
        working-directory: simulations
        run: |
          v=$(grep "Cumulative:" \
               github_top_simpoint_workflow/this_pr/500.perlbench_r/29229/core.stat.0.out | \
               sed -n 's/.*IPC: \([0-9.]*\).*/\1/p')
          echo "value=${v:-ERROR}" >>"$GITHUB_OUTPUT"

############################################################
# 7 â”€â”€â”€ JobÂ 3A: compare & comment (PRs only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
############################################################
  comment-pr:
    if: github.event_name == 'pull_request'
    needs: [run-scarab]
    runs-on: ubuntu-latest
    steps:
      # Baseline file ---------------------------------------
      - uses: actions/checkout@v4
        with:
          repository: litz-lab/scarab_perf
          path: baseline

      - id: base
        name: Read last baseline line
        run: |
          last=$(tail -n1 baseline/scarab_perf.log | tr -d '\r')
          IFS=',' read -r _ IPC KIPS <<<"$last"
          echo "ipc=$IPC"   >>"$GITHUB_OUTPUT"
          echo "kips=$KIPS" >>"$GITHUB_OUTPUT"

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const simKips  = parseFloat("${{ needs.run-scarab.outputs.kips }}");
            const simIpc   = parseFloat("${{ needs.run-scarab.outputs.ipc  }}");
            const baseKips = parseFloat("${{ steps.base.outputs.kips      }}");
            const baseIpc  = parseFloat("${{ steps.base.outputs.ipc       }}");

            // 1Ã— â†’ green, <1Ã— â†’ red, >1Ã— â†’ blue
            function coloured(v) {
              const EPS = 1e-3;          // tolerance for â€œequalâ€
              let colour = 'green';
              if (v > 1 + EPS) colour = 'blue';
              else if (v < 1 - EPS) colour = 'red';
              return `<span style="color:${colour};font-weight:bold">${v.toFixed(2)}Ã—</span>`;
            }

            const body = `
              ðŸ“Š **Scarab simulation**

              | Metric | PR | Baseline | Î” |
              | ------ | --:| -------: | :- |
              | **KIPS** | \`${simKips}\` | \`${baseKips}\` | ${coloured(simKips / baseKips)} |
              | **IPC**  | \`${simIpc}\`  | \`${baseIpc}\`  | ${coloured(simIpc  / baseIpc )} |
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

############################################################
# 8 â”€â”€â”€ JobÂ 3B: append to scarab_perf (push only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
############################################################
  update-baseline:
    if: github.event_name == 'push'
    needs: [run-scarab]
    runs-on: ubuntu-latest
    env:
      PERF_KEY: ${{ secrets.SCARAB_PERF_SSH_KEY }}
    steps:
      - name: Configure gitâ€‘ssh
        run: |
          mkdir -p ~/.ssh
          echo "$PERF_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone baseline repo (write)
        run: git clone git@github.com:litz-lab/scarab_perf.git perf

      - name: Append new metrics line
        run: |
          echo "${COMMIT_SHA},${{ needs.run-scarab.outputs.ipc }},${{ needs.run-scarab.outputs.kips }}" \
            >> perf/scarab_perf.log
          cd perf
          git add scarab_perf.log
          git commit -m "Add perf result for ${COMMIT_SHA}"
          git push
